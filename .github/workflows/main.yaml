name: Deploy

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      debug_enabled:
        description: "Run the workflow with debug logging"
        required: true
        default: true

jobs:
  build-and-push-to-ecr:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Log into AWS ECR
        id: login-aws-ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: private
      - name: Set Environment Variables
        run: |
          echo "ECR_REGISTRY=${{ steps.login-aws-ecr.outputs.registry }}" >> $GITHUB_ENV
          echo "ECR_REPOSITORY=${{ secrets.AWS_ECR_REPO }}" >> $GITHUB_ENV
          echo "BACKEND_IMAGE_TAG=backend-${{ github.sha }}" >> $GITHUB_ENV

      # Uses Dockerfile in api directory to build and push the backend image to AWS ECR
      - name: Build & Push Backend Docker Image to AWS ECR
        # in docker build, all steps in Dockerfile are followed to to create final image
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$BACKEND_IMAGE_TAG ./api
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$BACKEND_IMAGE_TAG

      - name: Fetch EC2 Instance IDs
        run: |
          INSTANCE_IDS=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=cwc-private-ec2-1,cwc-private-ec2-2" \
                      "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[?State.Name=='running'].[InstanceId]" \
            --output text | tr '\n' ' ')
          echo "INSTANCE_IDS=$INSTANCE_IDS" >> $GITHUB_ENV
          echo "Fetched EC2 Instance IDs: $INSTANCE_IDS"

      - name: Deploy to EC2 Instances
        run: |
          # Convert space-separated instance IDs to comma-separated
          IFS=' ' read -ra INSTANCE_ARRAY <<< "${{ env.INSTANCE_IDS }}"
          INSTANCE_IDS_FORMATTED=$(IFS=,; echo "${INSTANCE_ARRAY[*]}")

          echo "Deploying to instances: $INSTANCE_IDS_FORMATTED"

          COMMAND_ID=$(aws ssm send-command \
            --targets "Key=InstanceIds,Values=$INSTANCE_IDS_FORMATTED" \
            --document-name "AWS-RunShellScript" \
            --output text \
            --query "Command.CommandId" \
            --parameters '{
              "commands": [
                "echo \"$(date): Current containers:\"",
                "docker ps --format \"ID: {{.ID}} - Name: {{.Names}} - Image: {{.Image}} - Status: {{.Status}}\"",
                "echo \"$(date): Logging in to ECR...\"",
                "aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${ECR_REGISTRY} || { echo \"ECR login failed\"; exit 1; }",
                "echo \"$(date): Pulling new image...\"",
                "docker pull ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG} || { echo \"Docker pull failed\"; exit 1; }",
                "echo \"$(date): Stopping and removing old containers...\"",
                "docker ps -a --format \"{{.Names}}\" | grep \"^backend-\" || echo \"No existing backend containers found\"",
                "docker ps -q --filter name=backend-* | xargs -r docker stop",
                "docker ps -aq --filter name=backend-* | xargs -r docker rm",
                "echo \"$(date): Starting new container...\"",
                "docker run -d --name ${CONTAINER_NAME} -p 3005:3005 ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG} || { echo \"Docker run failed\"; exit 1; }",
                "echo \"$(date): Containers after deployment:\"",
                "docker ps --format \"ID: {{.ID}} - Name: {{.Names}} - Image: {{.Image}} - Status: {{.Status}}\""
              ]
            }') || { echo "Failed to send SSM command"; exit 1; }

          echo "SSM Command ID: $COMMAND_ID"

          # Wait for command to complete
          aws ssm wait command-executed --command-id "$COMMAND_ID" --targets "Key=InstanceIds,Values=$INSTANCE_IDS_FORMATTED"

          # Get command invocation results
          aws ssm list-command-invocations --command-id "$COMMAND_ID" --details
